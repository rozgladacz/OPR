{% extends "base.html" %}
{% block title %}Rozpiska {{ roster.name }} - OPR{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Rozpiska: {{ roster.name }}</h2>
  <div>
    <a class="btn btn-outline-secondary" href="/rosters">Wróć</a>
    <a class="btn btn-success" href="/rosters/{{ roster.id }}/print" target="_blank">Widok do druku</a>
    <a class="btn btn-outline-success" href="/rosters/{{ roster.id }}/pdf">Pobierz PDF</a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Informacje</h5>
    <form method="post" action="/rosters/{{ roster.id }}/update" class="row g-3 align-items-end">
      <div class="col-md-5">
        <label class="form-label" for="name">Nazwa</label>
        <input class="form-control" id="name" name="name" value="{{ roster.name }}" required {% if not can_edit %}disabled{% endif %} />
      </div>
      <div class="col-md-3">
        <label class="form-label">Armia</label>
        <input class="form-control" value="{{ roster.army.name }}" disabled />
      </div>
      <div class="col-md-2">
        <label class="form-label" for="points_limit">Limit</label>
        <input class="form-control" id="points_limit" name="points_limit" type="number" value="{{ roster.points_limit }}" {% if not can_edit %}disabled{% endif %} />
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary" type="submit" {% if not can_edit %}disabled{% endif %}>Zapisz</button>
      </div>
    </form>
    {% if not can_edit %}
    <div class="alert alert-info mt-3">
      Jest to rozpiska globalna. Modyfikacje są dostępne jedynie dla administratora.
    </div>
    {% endif %}
  </div>
</div>

<div class="row g-4">
  {% if can_edit %}
  <div class="col-lg-5">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Dodaj jednostkę</h5>
        {% if available_units %}
        <form method="post" action="/rosters/{{ roster.id }}/units/add" data-roster-unit-form>
          <div class="mb-3">
            <label class="form-label" for="unit_id">Jednostka</label>
            <select class="form-select" id="unit_id" name="unit_id" required data-roster-unit-select>
              {% for entry in available_units %}
              <option
                value="{{ entry.unit.id }}"
                data-weapons="{{ entry.weapon_options | tojson | e }}"
                data-default-summary="{{ entry.default_summary | e }}"
                {% if loop.first %}selected{% endif %}
              >
                {{ entry.unit.name }} (Jakość {{ entry.unit.quality }} / Obrona {{ entry.unit.defense }} /
                Wytrzymałość {{ entry.unit.toughness }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="count">Ilość</label>
              <input class="form-control" id="count" name="count" type="number" min="1" value="1" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="selected_weapon_id">Broń</label>

              <select
                class="form-select"
                id="selected_weapon_id"
                name="selected_weapon_id"
                data-roster-weapon-select
                data-placeholder="Domyślne wyposażenie"
              >
                <option value="">Domyślne wyposażenie</option>
              </select>
              <div class="form-text" data-roster-default-summary>Domyślne wyposażenie: -</div>
            </div>
          </div>
          <button class="btn btn-success mt-3" type="submit">Dodaj</button>
        </form>
        {% else %}
        <div class="alert alert-info mb-0">Brak jednostek w wybranej armii.</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
  <div class="{% if can_edit %}col-lg-7{% else %}col-12{% endif %}">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Twoja rozpiska</h5>
        <p>Suma punktów: <strong>{{ total_cost }}</strong>{% if roster.points_limit %} / {{ roster.points_limit }}{% endif %}</p>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Jednostka</th>
              <th>Ilość</th>
              <th>Broń</th>
              <th>Koszt</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for item in roster_items %}
            {% set ru = item.instance %}
            <tr>
              <td>
                <div class="fw-semibold">{{ ru.unit.name }}</div>
                <div class="text-muted small">
                  Jakość {{ ru.unit.quality }} / Obrona {{ ru.unit.defense }} / Wytrzymałość {{ ru.unit.toughness }}
                </div>
                <div class="d-flex flex-wrap gap-1 mt-2">
                  {% for label in item.passive_labels %}
                  <span class="badge text-bg-secondary">{{ label }}</span>
                  {% endfor %}
                  {% for label in item.active_labels %}
                  <span class="badge text-bg-info text-dark">{{ label }}</span>
                  {% endfor %}
                  {% for label in item.aura_labels %}
                  <span class="badge text-bg-warning text-dark">{{ label }}</span>
                  {% endfor %}
                  {% if not item.passive_labels and not item.active_labels and not item.aura_labels %}
                  <span class="text-muted small">Brak dodatkowych zdolności</span>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if can_edit %}
                <form method="post" action="/rosters/{{ roster.id }}/units/{{ ru.id }}/update" class="d-flex flex-column flex-sm-row gap-2" data-roster-unit-form>
                  <input class="form-control form-control-sm" name="count" type="number" min="1" value="{{ ru.count }}" />

                  <select
                    class="form-select form-select-sm"
                    name="selected_weapon_id"
                    data-roster-weapon-select
                    data-placeholder="Domyślne wyposażenie"
                    data-selected="{{ ru.selected_weapon_id or '' }}"
                  >
                    <option value="">Domyślne wyposażenie{% if item.default_summary != '-' %} ({{ item.default_summary }}){% endif %}</option>
                    {% for weapon in item.weapon_options %}
                    <option value="{{ weapon.id }}" {% if weapon.id == ru.selected_weapon_id %}selected{% endif %}>{{ weapon.name }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-sm btn-primary" type="submit">Aktualizuj</button>
                </form>
                {% else %}
                {{ ru.count }}
                {% endif %}
              </td>
              <td>
                {% if ru.selected_weapon %}
                {{ ru.selected_weapon.effective_name }}

                {% else %}
                {{ item.default_summary }}

                {% endif %}
              </td>
              <td>{{ ru.cached_cost }}</td>
              <td>
                {% if can_edit %}
                <form method="post" action="/rosters/{{ roster.id }}/units/{{ ru.id }}/delete" onsubmit="return confirm('Usunąć pozycję?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Usuń</button>
                </form>
                {% else %}
                <span class="text-muted small">Tylko podgląd</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-muted">Dodaj jednostki aby rozpocząć budowę rozpiski.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
